<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Grist Map Widget ‚Äì Types A/B/C</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap');

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'DM Sans', sans-serif;
      background: #0f1117;
      color: #e4e4e7;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    #map {
      flex: 1;
      z-index: 1;
    }

    /* L√©gende flottante */
    .legend {
      position: absolute;
      bottom: 24px;
      left: 24px;
      z-index: 1000;
      background: rgba(15, 17, 23, 0.88);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      padding: 14px 20px;
      display: flex;
      gap: 20px;
      align-items: center;
      font-size: 13px;
      font-weight: 500;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .legend-dot {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      box-shadow: 0 0 8px rgba(0,0,0,0.3);
    }

    .legend-dot.type-a { background: #3b82f6; box-shadow: 0 0 10px rgba(59,130,246,0.4); }
    .legend-dot.type-b { background: #f59e0b; box-shadow: 0 0 10px rgba(245,158,11,0.4); }
    .legend-dot.type-c { background: #10b981; box-shadow: 0 0 10px rgba(16,185,129,0.4); }

    /* Info panel quand pas de donn√©es */
    .info-panel {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
      background: rgba(15, 17, 23, 0.92);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 18px;
      padding: 32px 40px;
      text-align: center;
      max-width: 480px;
      box-shadow: 0 16px 48px rgba(0,0,0,0.5);
    }

    .info-panel h2 {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 12px;
      color: #fff;
    }

    .info-panel p {
      font-size: 13px;
      color: #9ca3af;
      line-height: 1.7;
    }

    .info-panel code {
      background: rgba(255,255,255,0.08);
      padding: 2px 7px;
      border-radius: 5px;
      font-size: 12px;
      color: #c4b5fd;
    }

    /* Stats compteur */
    .stats-bar {
      position: absolute;
      top: 12px;
      right: 12px;
      z-index: 1000;
      display: flex;
      gap: 8px;
    }

    .stat-chip {
      background: rgba(15, 17, 23, 0.85);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 10px;
      padding: 8px 14px;
      font-size: 12px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.3);
    }

    .stat-chip .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    /* Custom popups Leaflet */
    .leaflet-popup-content-wrapper {
      background: rgba(15, 17, 23, 0.92) !important;
      backdrop-filter: blur(16px);
      border: 1px solid rgba(255,255,255,0.1) !important;
      border-radius: 12px !important;
      color: #e4e4e7 !important;
      font-family: 'DM Sans', sans-serif !important;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5) !important;
    }

    .leaflet-popup-content {
      margin: 12px 16px !important;
      font-size: 13px !important;
      line-height: 1.6 !important;
    }

    .leaflet-popup-content strong {
      color: #fff;
      font-weight: 600;
    }

    .leaflet-popup-tip {
      background: rgba(15, 17, 23, 0.92) !important;
      border: 1px solid rgba(255,255,255,0.1) !important;
    }

    .popup-type-badge {
      display: inline-block;
      padding: 2px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .popup-type-badge.type-a { background: rgba(59,130,246,0.2); color: #60a5fa; }
    .popup-type-badge.type-b { background: rgba(245,158,11,0.2); color: #fbbf24; }
    .popup-type-badge.type-c { background: rgba(16,185,129,0.2); color: #34d399; }
  </style>
</head>
<body>

  <div id="map"></div>

  <div class="legend">
    <div class="legend-item">
      <div class="legend-dot type-a"></div>
      <span>Type A</span>
    </div>
    <div class="legend-item">
      <div class="legend-dot type-b"></div>
      <span>Type B</span>
    </div>
    <div class="legend-item">
      <div class="legend-dot type-c"></div>
      <span>Type C</span>
    </div>
  </div>

  <div class="stats-bar" id="stats-bar"></div>

  <div class="info-panel" id="info-panel" style="display: none;">
    <h2>üó∫Ô∏è Widget Carte Grist</h2>
    <p>
      Ce widget affiche des marqueurs color√©s selon leur type.<br><br>
      Colonnes attendues dans votre table Grist :<br>
      <code>Latitude</code> ¬∑ <code>Longitude</code> ¬∑ <code>Type</code> (A, B ou C)<br>
      Optionnel : <code>Nom</code> ¬∑ <code>Description</code><br><br>
      Les donn√©es de d√©monstration sont affich√©es ci-dessous.
    </p>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Grist Plugin API -->
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>

  <script>
    // ‚îÄ‚îÄ‚îÄ Configuration couleurs par type ‚îÄ‚îÄ‚îÄ
    const TYPE_COLORS = {
      A: { fill: '#3b82f6', glow: 'rgba(59,130,246,0.5)',  cls: 'type-a' },
      B: { fill: '#f59e0b', glow: 'rgba(245,158,11,0.5)',  cls: 'type-b' },
      C: { fill: '#10b981', glow: 'rgba(16,185,129,0.5)',   cls: 'type-c' },
    };

    const DEFAULT_COLOR = { fill: '#6b7280', glow: 'rgba(107,114,128,0.4)', cls: '' };

    // ‚îÄ‚îÄ‚îÄ Initialiser la carte Leaflet ‚îÄ‚îÄ‚îÄ
    const map = L.map('map', {
      zoomControl: false,
      attributionControl: true
    }).setView([46.8, 2.5], 6); // Centre France par d√©faut

    L.control.zoom({ position: 'topright' }).addTo(map);

    // Tuile CartoDB Dark (th√®me sombre √©l√©gant)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 19
    }).addTo(map);

    // Layer group pour les marqueurs
    let markersLayer = L.layerGroup().addTo(map);

    // ‚îÄ‚îÄ‚îÄ Cr√©er un ic√¥ne SVG circulaire ‚îÄ‚îÄ‚îÄ
    function createCircleIcon(type) {
      const color = TYPE_COLORS[type?.toUpperCase()] || DEFAULT_COLOR;
      const svg = `
        <svg width="28" height="28" viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg">
          <circle cx="14" cy="14" r="12" fill="${color.fill}" stroke="rgba(255,255,255,0.9)" stroke-width="2.5"
                  filter="drop-shadow(0 0 6px ${color.glow})"/>
          <circle cx="14" cy="14" r="5" fill="rgba(255,255,255,0.85)"/>
        </svg>`;
      return L.divIcon({
        html: svg,
        className: '',
        iconSize: [28, 28],
        iconAnchor: [14, 14],
        popupAnchor: [0, -16]
      });
    }

    // ‚îÄ‚îÄ‚îÄ Popup HTML ‚îÄ‚îÄ‚îÄ
    function createPopupContent(record) {
      const type = (record.Type || record.type || '?').toString().toUpperCase();
      const color = TYPE_COLORS[type] || DEFAULT_COLOR;
      const name = record.Nom || record.nom || record.Name || record.name || '';
      const desc = record.Description || record.description || '';

      let html = `<div class="popup-type-badge ${color.cls}">Type ${type}</div>`;
      if (name) html += `<br><strong>${name}</strong>`;
      if (desc) html += `<br><span style="color:#9ca3af">${desc}</span>`;
      html += `<br><span style="color:#6b7280;font-size:11px">${record._lat?.toFixed(5)}, ${record._lng?.toFixed(5)}</span>`;
      return html;
    }

    // ‚îÄ‚îÄ‚îÄ Mettre √† jour les stats ‚îÄ‚îÄ‚îÄ
    function updateStats(records) {
      const counts = { A: 0, B: 0, C: 0 };
      records.forEach(r => {
        const t = (r.Type || r.type || '').toString().toUpperCase();
        if (counts.hasOwnProperty(t)) counts[t]++;
      });

      const bar = document.getElementById('stats-bar');
      bar.innerHTML = Object.entries(counts)
        .filter(([, count]) => count > 0)
        .map(([type, count]) => {
          const c = TYPE_COLORS[type];
          return `<div class="stat-chip">
            <div class="dot" style="background:${c.fill};box-shadow:0 0 6px ${c.glow}"></div>
            ${count}
          </div>`;
        }).join('');
    }

    // ‚îÄ‚îÄ‚îÄ Afficher les points ‚îÄ‚îÄ‚îÄ
    function renderPoints(records) {
      markersLayer.clearLayers();

      const validRecords = [];

      records.forEach(record => {
        const lat = parseFloat(record.Latitude || record.latitude || record.Lat || record.lat);
        const lng = parseFloat(record.Longitude || record.longitude || record.Lng || record.lng || record.Lon || record.lon);
        const type = (record.Type || record.type || '').toString().toUpperCase();

        if (isNaN(lat) || isNaN(lng)) return;

        record._lat = lat;
        record._lng = lng;

        const marker = L.marker([lat, lng], { icon: createCircleIcon(type) });
        marker.bindPopup(createPopupContent(record), { maxWidth: 260 });
        markersLayer.addLayer(marker);

        validRecords.push(record);
      });

      // Ajuster la vue
      if (validRecords.length > 0) {
        const bounds = L.latLngBounds(validRecords.map(r => [r._lat, r._lng]));
        map.fitBounds(bounds.pad(0.15));
      }

      updateStats(validRecords);
    }

    // ‚îÄ‚îÄ‚îÄ Donn√©es de d√©monstration ‚îÄ‚îÄ‚îÄ
    const DEMO_DATA = [
      { Nom: "Paris ‚Äì Si√®ge", Latitude: 48.8566, Longitude: 2.3522, Type: "A", Description: "Bureau principal" },
      { Nom: "Lyon ‚Äì Agence", Latitude: 45.7640, Longitude: 4.8357, Type: "B", Description: "Agence r√©gionale" },
      { Nom: "Marseille ‚Äì D√©p√¥t", Latitude: 43.2965, Longitude: 5.3698, Type: "C", Description: "Entrep√¥t logistique" },
      { Nom: "Bordeaux", Latitude: 44.8378, Longitude: -0.5792, Type: "A", Description: "Antenne commerciale" },
      { Nom: "Lille ‚Äì Nord", Latitude: 50.6292, Longitude: 3.0573, Type: "B", Description: "Point relais" },
      { Nom: "Strasbourg", Latitude: 48.5734, Longitude: 7.7521, Type: "C", Description: "Bureau Est" },
      { Nom: "Toulouse", Latitude: 43.6047, Longitude: 1.4442, Type: "A", Description: "Centre technique" },
      { Nom: "Nantes", Latitude: 47.2184, Longitude: -1.5536, Type: "B", Description: "Agence Ouest" },
      { Nom: "Rennes", Latitude: 48.1173, Longitude: -1.6778, Type: "C", Description: "Point de contact" },
      { Nom: "Montpellier", Latitude: 43.6108, Longitude: 3.8767, Type: "A", Description: "Bureau Sud" },
      { Nom: "Grenoble", Latitude: 45.1885, Longitude: 5.7245, Type: "B", Description: "Labo R&D" },
      { Nom: "Clermont-Ferrand", Latitude: 45.7772, Longitude: 3.0870, Type: "C", Description: "Centre support" },
    ];

    // ‚îÄ‚îÄ‚îÄ Int√©gration Grist ‚îÄ‚îÄ‚îÄ
    let gristReady = false;

    function tryGristInit() {
      if (typeof grist === 'undefined') {
        // Pas dans Grist ‚Üí afficher la d√©mo
        showDemo();
        return;
      }

      try {
        grist.ready({
          requiredAccess: 'read table',
          columns: [
            { name: 'Latitude', type: 'Numeric' },
            { name: 'Longitude', type: 'Numeric' },
            { name: 'Type', type: 'Text' },
            { name: 'Nom', type: 'Text', optional: true },
            { name: 'Description', type: 'Text', optional: true },
          ]
        });

        gristReady = true;

        grist.onRecords(function(records) {
          if (records && records.length > 0) {
            document.getElementById('info-panel').style.display = 'none';
            renderPoints(records);
          } else {
            showDemo();
          }
        });

      } catch (e) {
        console.warn('Grist API non disponible, mode d√©mo.', e);
        showDemo();
      }
    }

    function showDemo() {
      document.getElementById('info-panel').style.display = 'block';
      renderPoints(DEMO_DATA);

      // Masquer le panel d'info apr√®s 5s
      setTimeout(() => {
        const panel = document.getElementById('info-panel');
        panel.style.transition = 'opacity 0.6s ease';
        panel.style.opacity = '0';
        setTimeout(() => panel.style.display = 'none', 600);
      }, 6000);
    }

    // D√©marrage
    tryGristInit();
  </script>
</body>
</html>
