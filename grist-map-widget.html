<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Grist Map Widget – Auto-détection catégories</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap');

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'DM Sans', sans-serif;
      background: #0f1117;
      color: #e4e4e7;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    #map { flex: 1; z-index: 1; }

    /* ─── Bouton Settings ─── */
    .settings-toggle {
      position: absolute;
      top: 12px;
      left: 12px;
      z-index: 1100;
      width: 40px;
      height: 40px;
      border-radius: 11px;
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(15, 17, 23, 0.88);
      backdrop-filter: blur(14px);
      color: #e4e4e7;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s, transform 0.2s;
      box-shadow: 0 4px 16px rgba(0,0,0,0.35);
    }
    .settings-toggle:hover {
      background: rgba(30, 33, 44, 0.95);
      transform: scale(1.05);
    }

    /* ─── Panneau Settings ─── */
    .settings-panel {
      position: absolute;
      top: 60px;
      left: 12px;
      z-index: 1100;
      background: rgba(15, 17, 23, 0.94);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px;
      padding: 22px 24px 18px;
      width: 340px;
      max-height: calc(100vh - 90px);
      overflow-y: auto;
      box-shadow: 0 12px 48px rgba(0,0,0,0.5);
      display: none;
      animation: slideIn 0.25s ease;
    }
    .settings-panel.open { display: block; }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-8px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .settings-panel h3 {
      font-size: 14px;
      font-weight: 700;
      color: #fff;
      margin-bottom: 6px;
    }

    .settings-panel .subtitle {
      font-size: 11.5px;
      color: #6b7280;
      margin-bottom: 16px;
      line-height: 1.5;
    }

    .cat-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
      padding: 8px 10px;
      border-radius: 10px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.05);
      transition: background 0.15s;
    }
    .cat-row:hover { background: rgba(255,255,255,0.06); }

    .cat-color-btn {
      width: 30px;
      height: 30px;
      border-radius: 8px;
      flex-shrink: 0;
      border: 2.5px solid rgba(255,255,255,0.15);
      cursor: pointer;
      transition: transform 0.15s, border-color 0.15s;
    }
    .cat-color-btn:hover {
      transform: scale(1.1);
      border-color: rgba(255,255,255,0.35);
    }

    .cat-name {
      flex: 1;
      font-size: 13px;
      font-weight: 500;
      color: #e4e4e7;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .cat-count {
      font-size: 11px;
      color: #6b7280;
      background: rgba(255,255,255,0.05);
      padding: 3px 8px;
      border-radius: 6px;
      flex-shrink: 0;
      font-weight: 600;
    }

    /* ─── Color Picker Dropdown ─── */
    .color-picker-dropdown {
      position: absolute;
      z-index: 1200;
      background: rgba(20, 22, 30, 0.96);
      backdrop-filter: blur(16px);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 10px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      width: 180px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
      animation: fadeIn 0.15s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to   { opacity: 1; transform: scale(1); }
    }

    .color-picker-dropdown .color-option {
      width: 28px;
      height: 28px;
      border-radius: 7px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: transform 0.12s, border-color 0.12s;
    }
    .color-picker-dropdown .color-option:hover {
      transform: scale(1.15);
      border-color: rgba(255,255,255,0.5);
    }
    .color-picker-dropdown .color-option.selected {
      border-color: #fff;
      box-shadow: 0 0 8px rgba(255,255,255,0.3);
    }

    .color-picker-dropdown .no-color {
      width: 28px;
      height: 28px;
      border-radius: 7px;
      cursor: pointer;
      border: 2px dashed rgba(255,255,255,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: #6b7280;
      transition: transform 0.12s;
    }
    .color-picker-dropdown .no-color:hover { transform: scale(1.15); }

    /* ─── Légende flottante ─── */
    .legend {
      position: absolute;
      bottom: 24px;
      left: 24px;
      z-index: 1000;
      background: rgba(15, 17, 23, 0.88);
      backdrop-filter: blur(16px);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      padding: 14px 20px;
      display: flex;
      gap: 18px;
      align-items: center;
      font-size: 13px;
      font-weight: 500;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
      flex-wrap: wrap;
    }
    .legend:empty { display: none; }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .legend-dot {
      width: 14px;
      height: 14px;
      border-radius: 50%;
    }

    /* ─── Stats ─── */
    .stats-bar {
      position: absolute;
      top: 12px;
      right: 12px;
      z-index: 1000;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .stat-chip {
      background: rgba(15, 17, 23, 0.85);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 10px;
      padding: 8px 14px;
      font-size: 12px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.3);
    }

    .stat-chip .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    /* ─── Popups Leaflet ─── */
    .leaflet-popup-content-wrapper {
      background: rgba(15, 17, 23, 0.92) !important;
      backdrop-filter: blur(16px);
      border: 1px solid rgba(255,255,255,0.1) !important;
      border-radius: 12px !important;
      color: #e4e4e7 !important;
      font-family: 'DM Sans', sans-serif !important;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5) !important;
    }

    .leaflet-popup-content {
      margin: 12px 16px !important;
      font-size: 13px !important;
      line-height: 1.6 !important;
    }

    .leaflet-popup-content strong { color: #fff; font-weight: 600; }

    .leaflet-popup-tip {
      background: rgba(15, 17, 23, 0.92) !important;
      border: 1px solid rgba(255,255,255,0.1) !important;
    }

    .popup-type-badge {
      display: inline-block;
      padding: 2px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.3px;
      margin-bottom: 4px;
    }

    .settings-panel::-webkit-scrollbar { width: 5px; }
    .settings-panel::-webkit-scrollbar-track { background: transparent; }
    .settings-panel::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }
  </style>
</head>
<body>

  <div id="map"></div>

  <button class="settings-toggle" id="settingsToggle" title="Configurer les catégories">⚙</button>

  <div class="settings-panel" id="settingsPanel">
    <h3>Catégories détectées</h3>
    <div class="subtitle">Cliquez sur le rond de couleur pour changer la couleur associée à chaque valeur.</div>
    <div id="categoriesList"></div>
  </div>

  <div class="legend" id="legend"></div>
  <div class="stats-bar" id="stats-bar"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>

  <script>
    // ─── Palette pastel douce ───
    const PASTEL_PALETTE = [
      { id: 'blue',   fill: '#93c5fd', glow: 'rgba(147,197,253,0.45)', bg: 'rgba(147,197,253,0.15)', text: '#93c5fd' },
      { id: 'pink',   fill: '#fda4af', glow: 'rgba(253,164,175,0.45)', bg: 'rgba(253,164,175,0.15)', text: '#fda4af' },
      { id: 'green',  fill: '#86efac', glow: 'rgba(134,239,172,0.45)', bg: 'rgba(134,239,172,0.15)', text: '#86efac' },
      { id: 'yellow', fill: '#fcd34d', glow: 'rgba(252,211,77,0.40)',  bg: 'rgba(252,211,77,0.15)',  text: '#fcd34d' },
      { id: 'violet', fill: '#c4b5fd', glow: 'rgba(196,181,253,0.45)', bg: 'rgba(196,181,253,0.15)', text: '#c4b5fd' },
    ];

    const UNASSIGNED_COLOR = { id: 'none', fill: '#6b7280', glow: 'rgba(107,114,128,0.25)', bg: 'rgba(107,114,128,0.1)', text: '#9ca3af' };

    // ─── État ───
    const STORAGE_KEY = 'grist_map_color_mapping_v4';
    let colorMapping = loadMapping();   // { "valeur_type": "color_id" }
    let detectedTypes = [];             // [ { name, count } ]
    let lastRecords = [];
    let columnMapping = {};             // mapping Grist : { Latitude: "real_col_name", ... }
    let openPicker = null;

    function loadMapping() {
      try { const s = localStorage.getItem(STORAGE_KEY); if (s) return JSON.parse(s); } catch(e) {}
      return {};
    }
    function saveMapping() {
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify(colorMapping)); } catch(e) {}
    }

    function getColorById(id) { return PASTEL_PALETTE.find(c => c.id === id) || UNASSIGNED_COLOR; }
    function getColorForType(typeName) { return getColorById(colorMapping[typeName] || 'none'); }

    function autoAssign() {
      const usedColors = new Set(Object.values(colorMapping));
      const available = PASTEL_PALETTE.filter(c => !usedColors.has(c.id));
      let idx = 0;
      detectedTypes.forEach(dt => {
        if (!colorMapping[dt.name] && idx < available.length) {
          colorMapping[dt.name] = available[idx].id;
          idx++;
        }
      });
      saveMapping();
    }

    // ─── Helpers pour lire les champs d'un record Grist ───
    // Grist envoie les données avec les noms de colonnes RÉELS de la table.
    // Le mapping widget (panneau droit dans Grist) associe nos noms logiques
    // (Latitude, Longitude, Type, Nom) aux vraies colonnes de la table.
    // grist.onRecords envoie les données avec les clés = vrais noms de colonnes.
    // On doit donc utiliser columnMapping pour retrouver la bonne clé.

    function getField(record, logicalName) {
      // Essayer le nom mappé par Grist
      const mappedCol = columnMapping[logicalName];
      if (mappedCol && record[mappedCol] !== undefined) return record[mappedCol];
      // Fallback : essayer le nom logique directement (mode démo)
      if (record[logicalName] !== undefined) return record[logicalName];
      return undefined;
    }

    function getLatitude(record) {
      const v = getField(record, 'Latitude');
      return (v !== undefined) ? parseFloat(v) : NaN;
    }

    function getLongitude(record) {
      const v = getField(record, 'Longitude');
      return (v !== undefined) ? parseFloat(v) : NaN;
    }

    function getType(record) {
      const v = getField(record, 'Type');
      return (v !== undefined && v !== null) ? String(v).trim() : '';
    }

    function getNom(record) {
      const v = getField(record, 'Nom');
      return (v !== undefined && v !== null) ? String(v).trim() : '';
    }

    // ─── Carte Leaflet ───
    const map = L.map('map', { zoomControl: false, attributionControl: true }).setView([46.8, 2.5], 6);
    L.control.zoom({ position: 'topright' }).addTo(map);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OSM &copy; CARTO', subdomains: 'abcd', maxZoom: 19
    }).addTo(map);

    let markersLayer = L.layerGroup().addTo(map);

    function createIcon(typeName) {
      const c = getColorForType(typeName);
      return L.divIcon({
        html: `<svg width="28" height="28" viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg">
          <circle cx="14" cy="14" r="12" fill="${c.fill}" stroke="rgba(255,255,255,0.85)" stroke-width="2.5" filter="drop-shadow(0 0 6px ${c.glow})"/>
          <circle cx="14" cy="14" r="5" fill="rgba(255,255,255,0.8)"/>
        </svg>`,
        className: '', iconSize: [28, 28], iconAnchor: [14, 14], popupAnchor: [0, -16]
      });
    }

    function popupHTML(record) {
      const type = getType(record);
      const nom = getNom(record);
      const c = getColorForType(type);

      let h = '';
      if (nom) h += `<strong>${nom}</strong><br>`;
      if (type) h += `<div class="popup-type-badge" style="background:${c.bg};color:${c.text}">${type}</div>`;
      return h || '<span style="color:#6b7280">Aucune info</span>';
    }

    // ─── Légende ───
    function renderLegend() {
      document.getElementById('legend').innerHTML = detectedTypes
        .filter(dt => colorMapping[dt.name])
        .map(dt => {
          const c = getColorForType(dt.name);
          return `<div class="legend-item">
            <div class="legend-dot" style="background:${c.fill};box-shadow:0 0 8px ${c.glow}"></div>
            <span>${dt.name}</span>
          </div>`;
        }).join('');
    }

    // ─── Stats ───
    function updateStats() {
      document.getElementById('stats-bar').innerHTML = detectedTypes
        .filter(dt => dt.count > 0)
        .map(dt => {
          const c = getColorForType(dt.name);
          return `<div class="stat-chip">
            <div class="dot" style="background:${c.fill};box-shadow:0 0 6px ${c.glow}"></div>
            ${dt.count}
          </div>`;
        }).join('');
    }

    // ─── Détection des types uniques ───
    function detectTypes(records) {
      const counts = {};
      records.forEach(r => {
        const t = getType(r);
        if (!t) return;
        counts[t] = (counts[t] || 0) + 1;
      });
      detectedTypes = Object.entries(counts)
        .sort((a, b) => b[1] - a[1])
        .map(([name, count]) => ({ name, count }));

      // Nettoyer les mappings obsolètes
      const validNames = new Set(detectedTypes.map(d => d.name));
      Object.keys(colorMapping).forEach(k => { if (!validNames.has(k)) delete colorMapping[k]; });

      autoAssign();
    }

    // ─── Rendu points ───
    function renderPoints(records) {
      markersLayer.clearLayers();
      const valid = [];
      records.forEach(r => {
        const lat = getLatitude(r);
        const lng = getLongitude(r);
        if (isNaN(lat) || isNaN(lng)) return;
        r._lat = lat; r._lng = lng;
        const type = getType(r);
        L.marker([lat, lng], { icon: createIcon(type) })
          .bindPopup(popupHTML(r), { maxWidth: 280 })
          .addTo(markersLayer);
        valid.push(r);
      });
      if (valid.length > 0) map.fitBounds(L.latLngBounds(valid.map(r => [r._lat, r._lng])).pad(0.15));
      updateStats();
    }

    function refreshAll() {
      renderLegend();
      renderSettingsRows();
      if (lastRecords.length > 0) renderPoints(lastRecords);
    }

    // ─── Color Picker ───
    function closePicker() { if (openPicker) { openPicker.remove(); openPicker = null; } }

    function showColorPicker(typeName, anchorEl) {
      closePicker();
      const picker = document.createElement('div');
      picker.className = 'color-picker-dropdown';
      const rect = anchorEl.getBoundingClientRect();
      picker.style.left = (rect.right + 8) + 'px';
      picker.style.top = rect.top + 'px';

      PASTEL_PALETTE.forEach(color => {
        const opt = document.createElement('div');
        opt.className = 'color-option' + (colorMapping[typeName] === color.id ? ' selected' : '');
        opt.style.background = color.fill;
        opt.style.boxShadow = `0 0 8px ${color.glow}`;
        opt.addEventListener('click', (e) => {
          e.stopPropagation();
          // Libérer la couleur si prise par un autre type
          Object.keys(colorMapping).forEach(k => {
            if (colorMapping[k] === color.id && k !== typeName) delete colorMapping[k];
          });
          colorMapping[typeName] = color.id;
          saveMapping();
          closePicker();
          refreshAll();
        });
        picker.appendChild(opt);
      });

      const noColor = document.createElement('div');
      noColor.className = 'no-color';
      noColor.innerHTML = '∅';
      noColor.title = 'Aucune couleur';
      noColor.addEventListener('click', (e) => {
        e.stopPropagation();
        delete colorMapping[typeName];
        saveMapping();
        closePicker();
        refreshAll();
      });
      picker.appendChild(noColor);

      document.body.appendChild(picker);
      openPicker = picker;

      requestAnimationFrame(() => {
        const pr = picker.getBoundingClientRect();
        if (pr.right > window.innerWidth) picker.style.left = (rect.left - pr.width - 8) + 'px';
        if (pr.bottom > window.innerHeight) picker.style.top = (window.innerHeight - pr.height - 12) + 'px';
      });
    }

    document.addEventListener('click', (e) => {
      if (openPicker && !openPicker.contains(e.target) && !e.target.classList.contains('cat-color-btn')) closePicker();
    });

    // ─── Panneau Settings ───
    const settingsToggle = document.getElementById('settingsToggle');
    const settingsPanel = document.getElementById('settingsPanel');

    settingsToggle.addEventListener('click', (e) => {
      e.stopPropagation();
      settingsPanel.classList.toggle('open');
      closePicker();
    });
    map.on('click', () => { settingsPanel.classList.remove('open'); closePicker(); });

    function renderSettingsRows() {
      const list = document.getElementById('categoriesList');
      list.innerHTML = '';

      if (detectedTypes.length === 0) {
        list.innerHTML = '<div style="color:#6b7280;font-size:12px;padding:8px 0;">Aucune catégorie détectée.<br>Vérifiez le mapping de la colonne <b>Type</b> dans les paramètres du widget Grist.</div>';
        return;
      }

      detectedTypes.forEach(dt => {
        const c = getColorForType(dt.name);
        const row = document.createElement('div');
        row.className = 'cat-row';

        const colorBtn = document.createElement('div');
        colorBtn.className = 'cat-color-btn';
        colorBtn.style.background = c.fill;
        colorBtn.style.boxShadow = `0 0 8px ${c.glow}`;
        colorBtn.addEventListener('click', (e) => { e.stopPropagation(); showColorPicker(dt.name, colorBtn); });

        const nameEl = document.createElement('div');
        nameEl.className = 'cat-name';
        nameEl.textContent = dt.name;
        nameEl.title = dt.name;

        const countEl = document.createElement('div');
        countEl.className = 'cat-count';
        countEl.textContent = dt.count;

        row.appendChild(colorBtn);
        row.appendChild(nameEl);
        row.appendChild(countEl);
        list.appendChild(row);
      });
    }

    // ─── Données de démonstration ───
    const DEMO_DATA = [
      { Nom: "Paris – Siège",       Latitude: 48.8566, Longitude: 2.3522,  Type: "Un formateur" },
      { Nom: "Lyon – Agence",       Latitude: 45.7640, Longitude: 4.8357,  Type: "Plusieurs formateurs" },
      { Nom: "Marseille – Dépôt",   Latitude: 43.2965, Longitude: 5.3698,  Type: "Aucun formateur" },
      { Nom: "Bordeaux",            Latitude: 44.8378, Longitude: -0.5792, Type: "Un formateur" },
      { Nom: "Lille – Nord",        Latitude: 50.6292, Longitude: 3.0573,  Type: "Un candidat" },
      { Nom: "Strasbourg",          Latitude: 48.5734, Longitude: 7.7521,  Type: "Aucun formateur" },
      { Nom: "Toulouse",            Latitude: 43.6047, Longitude: 1.4442,  Type: "Un formateur" },
      { Nom: "Nantes",              Latitude: 47.2184, Longitude: -1.5536, Type: "Plusieurs formateurs" },
      { Nom: "Rennes",              Latitude: 48.1173, Longitude: -1.6778, Type: "Aucun formateur" },
      { Nom: "Montpellier",         Latitude: 43.6108, Longitude: 3.8767,  Type: "Un formateur" },
      { Nom: "Grenoble",            Latitude: 45.1885, Longitude: 5.7245,  Type: "Un candidat" },
      { Nom: "Clermont-Ferrand",    Latitude: 45.7772, Longitude: 3.0870,  Type: "Plusieurs formateurs" },
    ];

    // ─── Intégration Grist ───
    function processRecords(records) {
      lastRecords = records;
      detectTypes(records);
      refreshAll();
    }

    function tryGristInit() {
      if (typeof grist === 'undefined') { showDemo(); return; }

      try {
        grist.ready({
          requiredAccess: 'read table',
          columns: [
            { name: 'Latitude', type: 'Numeric', title: 'Latitude' },
            { name: 'Longitude', type: 'Numeric', title: 'Longitude' },
            { name: 'Type', type: 'Any', title: 'Type' },
            { name: 'Nom', type: 'Any', title: 'Nom (facultatif)', optional: true },
          ]
        });

        // Récupérer le mapping de colonnes configuré par l'utilisateur
        grist.onOptions(function(options) {
          // options n'est pas toujours utilisé pour le column mapping
        });

        grist.on('message', function(msg) {
          // Debug : afficher les messages Grist dans la console
          console.log('Grist message:', msg);
        });

        // Le column mapping est disponible via grist.mapColumnNames
        grist.onRecords(function(records, mappings) {
          console.log('Received records:', records?.length, 'mappings:', mappings);

          if (mappings) {
            // mappings = { Latitude: "real_col_name", Longitude: "real_col_name", ... }
            columnMapping = mappings;
            console.log('Column mapping:', columnMapping);
          }

          // Essayer de mapper les colonnes avec grist.mapColumnNames
          if (records && records.length > 0) {
            let mapped = records;
            try {
              mapped = grist.mapColumnNames(records);
              // Si mapColumnNames réussit, les records ont directement nos noms logiques
              if (mapped && mapped.length > 0 && mapped[0] !== null) {
                console.log('mapColumnNames succeeded, sample:', mapped[0]);
                processRecords(mapped);
                return;
              }
            } catch(e) {
              console.log('mapColumnNames not available or failed, using raw records');
            }

            // Fallback : utiliser les records bruts avec le mapping
            processRecords(records);
          } else {
            showDemo();
          }
        });

      } catch (e) {
        console.warn('Grist API error:', e);
        showDemo();
      }
    }

    function showDemo() { processRecords(DEMO_DATA); }

    // ─── Init ───
    tryGristInit();
  </script>
</body>
</html>
